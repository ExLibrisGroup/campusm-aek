# AEK Asset Store

AssetStore provides a way to explicitly store, retrieve, execute and evaluate assets (js, css, images, etc) in a range of supported local storage systems (indexDB, Web SQL, localStorage). AssetStore will automatically use the best storage system available on the client.

AssetStore provides a more robust alternative to standard URLCache and provides simple mechanics for prefetching assets asynchronously thus providing performance optimisations and offlineability.

## Usage (new AEK projects)

When creating a new project you can explicitly request the `assetstore` variation of the standard boilerplate.

```sh
aek create -b exlibris-boilerplate-aek-react@assetstore
```

That's it!!

## Usage (existing AEK projects)

To modify an existing AEK project, first install the `aek-asset-store` module in your project

```bash
aek install aek-asset-store --save-dev
```

In order to modify the way in which assets are loaded, you need to modify this section in the `src/screens/templates/master.ect` file.

Replace the following code...

```markup
<script type="text/aekdefer">

  var sheets = <<- JSON.stringify(@get_stylesheets()) >>;
  sheets = sheets.map(function(s) {return s.match(/^(https?:\/)?\//) && s || "[[__public_assets__]]/css/"+s+".css"});

  var scripts = <<- JSON.stringify(@get_scripts()) >>;
  scripts = scripts.map(function(s) {return s.match(/^(https?:\/)?\//) && s || "[[__public_assets__]]/js/"+s+".js"});

  _aekLoad(sheets.concat(scripts));

</script>

<script>
  window.addEventListener("load",function() {
    var script = document.createElement("script");
    script.src = "https://portal.ombiel.co.uk/assets/aek/aek-loader/0.0.6/packed/loader.js";
    document.head.appendChild(script);
  });
</script>
```

with this alternative...

```markup
<script>

  << include '../../node_modules/@ombiel/aek-asset-store/public/include.js' >>

  loadCampusmAssetStore(function(assetStore) {

    var sheets = <<- JSON.stringify(@get_stylesheets()) >>;
    sheets = sheets.map(function(s) {return s.match(/^(https?:\/)?\//) && s || "[[__public_assets__]]/css/"+s+".css"});

    var scripts = <<- JSON.stringify(@get_scripts()) >>;
    scripts = scripts.map(function(s) {return s.match(/^(https?:\/)?\//) && s || "[[__public_assets__]]/js/"+s+".js"});

    assetStore.fetchAssets(scripts);
    assetStore.loadCSS(sheets).then(function() {
      assetStore.loadJS(scripts);
    });

  });

</script>
```

## API

Once loaded, an instance of AssetManager is available from the global scope using `CampusM.assetStore` providing the following API.

----

** `assetStore.fetchAssets(url:string)` **  
** `assetStore.fetchAssets(urls:Array<string)` **

Asynchronously fetches and stores the assets given by the provided url(s). If the asset has already been fetched, no remote requests is made and the content is simply retrieved from storage.

returns : `Promise.<Array<{code: string; err: Error}>>`

-------------------------------

** `assetStore.loadJS(url:string)` **  
** `assetStore.loadJS(urls:Array<string>)` **

Performs a fetch (as above) and then evaluates/executes the code. For multiple URLs, the assets will be retrieved asynchronously but evaluated in the order provided in the array.

returns : `Promise`

-------------------

** `assetStore.loadCSS(url:string)` **  
** `assetStore.loadCSS(urls:Array<string)` **

Performs a fetch (as above) and then injects the stylesheet into the current document. For multiple URLs, the assets will be retrieved asynchronously but rendered in the order provided in the array.

returns : `Promise`

-----------------

** `assetStore.getImgSrc(url:string)` **

Performs a fetch (as above) and resolves with a valid data URI for the image. If the image can not be URI encoded due to cross-origin policy or otherwise, the promise will resolve with the original URL instead.

returns: `Promise.<string>`

----------

## Caveats

AssetsStore can only store assets when the following conditions are met.

1. Asset server must provide a `cache-control` http header for the asset.  

2. The `cache-control` must not include `no-cache`, `no-store`, `max-age=0` or `s-maxage=0`  

3. The server must provide cross-origin access (CORS) to the asset using `access-control-allow-origin`

The above conditions are met by the CampusM asset servers so any assets deployed via AEK tools should be suitable for storage.
