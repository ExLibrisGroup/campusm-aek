"use strict";
var ect = require("ect");
var _ = require("lodash");
var escape = require("he").escape;

module.exports = function(buildOptions,locals,template) {
  
  if(!template) { template = "templates/boilerplate.ect"; }
  if(!locals) { locals = {}; }
  if(!buildOptions) { buildOptions = {}; }

  locals.env = buildOptions.env;

  locals.twigify = function(v) {
    if(_.isNumber(v)) {
      return v;
    }
    else {
      return '"'+v.replace(/\"/gi,'""')+'"';
    }
  };

  locals.body_attributes = locals.body_attributes || "";
  locals.body_data_attributes = locals.body_data_attributes || {};

  // normalise scripts and stylesheets for environment
  if(locals.scripts) {
    locals.scripts = locals.scripts.map(function(script) {
      return script[buildOptions.env] || script;
    })
  }
  if(locals.stylesheets) {
    locals.stylesheets = locals.stylesheets.map(function(stylesheet) {
      return stylesheet[buildOptions.env] || stylesheet;
    })
  }

  
  var val;

  for(var name in locals.body_data_attributes) {
    val = locals.body_data_attributes[name];
    if(_.isString(val) || _.isNumber(val)) {
      locals.body_attributes += ' data-'+name+'="'+escape(val)+'" ';
    }
    else {
      locals.body_attributes += ' data-o-b-j-'+name+'="'+escape(JSON.stringify(val))+'" ';
    }
  }

  var renderer = ect({ root : "src/screens",open:"<<",close:">>" });

  return renderer.render(template, locals);
};
