var TWEEN = require("tween.js"),
    isAnimating = false,
    animRef,
    EventEmitter=require("../event-emitter"),
    _ = require("../utils");

// load polyfill for older browsers
require("requestanimationframe")


function startAnimation() {
  if(!isAnimating) {
    isAnimating = true
    animate()
  }
}

function stopAnimation() {
  _.defer(function() {
    if(animRef && TWEEN.getAll().length==0) {
      window.cancelAnimationFrame(animRef)
      isAnimating=false;
    }
  })
  
}

function animate(time) {
  TWEEN.update();
  animRef = window.requestAnimationFrame(animate)
}

module.exports = function(...args) {
  var tween = new TWEEN.Tween(...args);

  EventEmitter.init(tween)

  
  tween.onComplete(function(...args) {
    tween.trigger("complete",...args)
    stopAnimation()
  })
  tween.onComplete = function(fn) {
    tween.on("complete",fn)
  }
  tween.onStop(function(...args) {
    tween.trigger("stop",...args)
    stopAnimation()
  })
  tween.onStop = function(fn) {
    tween.on("stop",fn)
  }
  tween.onUpdate(function(...args) {
    tween.trigger("update",...args)
  })
  tween.onUpdate = function(fn) {
    tween.on("update",fn)
  }

  tween.tweenStart = tween.start

  tween.start = function() {
    startAnimation()
    this.tweenStart()
  }

  return tween

}