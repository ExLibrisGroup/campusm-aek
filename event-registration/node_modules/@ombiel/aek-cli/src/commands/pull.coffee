log = require("../logger")
Promise = require("rsvp").Promise
npm = require "../npm"
config = require "../config"
gulpTask = require("../gulp-task")

path = require("path");

_ = require("lodash")
fs = require("fs")
# URL = require("url")

request = require("request")


auth = require("../auth")
pullPackage = require("../pull-package")



module.exports =
  name:"pull"
  help:"Pull a package from the oMbiel registry"

  options:[
    {
      name:"username"
      message:"Please enter your App Manager username"
      noPrompt:true
    }
    {
      name:"password"
      message:"Please enter your App Manager password"
      inputType:"password"
      noPrompt:true
    }
    {
      name:"package"
      message:"Name of package to pull"
      position:1
      required:true
      promptIfMissing:true
    }
    {
      name:"destination"
      message:"Where do you want the package extracted to"
      position:2
    }
  ]

  callback:(options)->

    packageName = options.package
        
    if packageName.indexOf("@ombiel/")!=0
      packageName = "@ombiel/"+packageName

    options.package = packageName

    destination = options.destination = options.destination && path.resolve(options.destination) || packageName.split("/")[1]

    returnError = (err)->
      log.error(err?.message ? err)
      process.exit()

    pullPackage(options).then(
      ()-> 
        log.info("Successfully extracted")
        process.chdir(destination)
        log.info("Installing")
        npm.command("install")

      ,(err)->
        returnError(err)
    )


        


