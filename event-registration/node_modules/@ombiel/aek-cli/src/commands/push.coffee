log = require("../logger")
Promise = require("rsvp").Promise
npm = require "../npm"
config = require "../config"

_ = require("lodash")
fs = require("fs")
URL = require("url")


auth = require("../auth")



module.exports =
  name:"push"
  help:"Push a package to the AEK registry."

  options:[
    {
      name:"username"
      message:"Please enter your App Manager username"
      noPrompt:true
    }
    {
      name:"password"
      message:"Please enter your App Manager password"
      inputType:"password"
      noPrompt:true
    }
    {
      name:"tag"
      abbr:"t"
      message:"Registers the published package with the given tag"
      noPrompt:true
    }
  ]

  callback:(options)->

    returnError = (str)->
      log.error(str)
      process.exit()

    pjson = fs.readFileSync("./package.json")
    try
      pjson = JSON.parse(pjson)
    catch e
      returnError("Unable to parse package.json")

    ## check name
    name = pjson.name
    if !name
      returnError("""Package must have a name (eg {"name":"@ombiel/mypackage"})""")

    
    if name.indexOf("@ombiel")!=0
      returnError("""To push packages to the AEK registry, you must use the "ombiel" scope - please prefix your package name with "@ombiel" (eg {"name":"@ombiel/mypackage"})""")

    auth.getUserDetails(options)
      .then (userDetails)->
        opts = {}
        if options.tag
          opts.tag = options.tag
        npm.command("publish",opts)
        
        
      .catch (e)->
        log.error(e)



    # return true
