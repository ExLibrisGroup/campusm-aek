through = require('through2')
fs = require("fs")
path = require("path")
swig = require('swig')
extReplace = require("gulp-ext-replace")
_ = require("lodash")
rewire = require("rewire")
Promise = require("rsvp").Promise

#gutil = require('gulp-util')
#PluginError = gutil.PluginError


module.exports = (env)->

  through.obj (file, enc, cb)->

    
    ext = _.last(file.path.split("."))
    that = this

  
    try
      promise = Promise.resolve(rewire(file.path)(env:env))
      promise.then (content)->
        file.contents = new Buffer(content)
        file.path = file.path.replace(/\.\w+$/gi, ".twig")
        that.push(file)
        cb()
      promise.catch (err)->
        cb(err)      
    catch err
      cb(err)
