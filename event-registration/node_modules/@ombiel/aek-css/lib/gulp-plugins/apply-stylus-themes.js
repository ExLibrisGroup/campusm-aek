"use strict";

var thru = require("through2").obj;
var chalk = require("chalk");

// store a hash of themeVariables as we go along
var themeVariables = {};

// regexp to match purple variables
var rePurple = /([a-z0-9\-\_]*)purple([a-z0-9\-\_]*)/i,
    rePurpleG = new RegExp(rePurple.source,"gi");

// applyStylusThemes
module.exports = function() {
  return thru(function(file,enc,cb) {
    var contents = file.contents.toString();
    
    console.log(chalk.cyan("applyStylusThemes:"),file.relative);

    // replace .ombTheme mixin with a theme iteration 
    contents = contents.replace(/\.ombTheme/g,"for themeName,theme in themes");

    // replace purple classes with dynamic variable
    contents = contents.replace(/\.purple/g,".{themeName}");

    // find purple variables
    contents = contents.replace(rePurpleG,function(match) {
      match = match.match(rePurple);
      var variableName = match[1];
      variableName += match[2];
      if(!variableName) { variableName = "color"; }
      variableName = variableName.charAt(0).toLowerCase()+variableName.substr(1);
      themeVariables[variableName] = true;
      return "theme['"+variableName+"']";
    });

    file.contents = new Buffer(contents);

    this.push(file);

    cb();

  });
};

module.exports.themeVariables = themeVariables;
