
var gulp = require("gulp");
var aek = require("@ombiel/aek-cli");
var buildtools = require("@ombiel/aek-buildtools");
var aekGulp = buildtools.gulp;
var path = require("path");
var _ = require("lodash");
var predeploy = aekGulp.predeploy({gulp:gulp,buildTask:"build"});


var coreWebpackOptions = {
  srcBase:path.resolve(__dirname,"src/core/"),
  dest:path.resolve(__dirname,"public/"),
  recordHash:false,
  alias:{
    "-components":"@ombiel/aek-lib/react/components",
    "-aek":"@ombiel/aek-lib"
  },
  module:{
    loaders:[
      { test: /src\/(core|loaders).*\.js$/, loader: 'source-map-loader!babel?optional=runtime' }
    ]
  }
};

var loaderWebpackOptions = _.extend({},coreWebpackOptions,{srcBase:path.resolve(__dirname,"src/loaders/")});


/* ---- GULP TASKS ---------- */

gulp.task("build:core",function() {
  return aekGulp.webpack(true,coreWebpackOptions);
});

gulp.task("build",["build:core"],function() {
  return aekGulp.webpack(true,loaderWebpackOptions);
});

gulp.task("auth",function() { return aek.cli.processCommand("auth",{silent:true}); });

// predeloy task is triggered from `aek deploy` command
gulp.task("_predeploy",predeploy);


// must export this for use with aek-cli
module.exports = gulp;
