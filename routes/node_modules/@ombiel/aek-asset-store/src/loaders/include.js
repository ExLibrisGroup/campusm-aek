/* global __aekPackageVersion__ */

(function() {
  window.loadCampusmAssetStore = function(cb,version) {

    if(!version) { version = __aekPackageVersion__; }

    var onLoad = function() {
      if(cb) {
        cb(window.CampusM.assetStore);
      }
    };

    var store;
    try {
      store = JSON.parse(window.localStorage.__campusmAssetStore);
    }
    catch(e) {} // eslint-disable-line no-empty

    if(store && store.version >= version) {
      (new Function(store.code))();
      onLoad();
    }
    else {
      var script = document.createElement("script");
      script.onload = onLoad;
      script.onError = function() {
        if(store) {
          console.warn("AssetStore: Unable to fetch minimum version " + store.version + " instead"); // eslint-disable-line no-console
          (new Function(store.code))();
          onLoad();
        }
        else {
          console.error("AssetStore: unable to initialise AssetStore");  // eslint-disable-line no-console
        }
      };
      script.src = "https://portal.ombiel.co.uk/assets/aek/aek-asset-store/" + version + "/loader.js";
      document.head.appendChild(script);
    }
  };

})();
