const fs = require("fs");
const _ = require("lodash");

class FStore {
  constructor(filename,base = []) {

    if (typeof (base) === "string") {
      base = base.split(".");
    }
    this.filename = filename;
    this.base = base;
    this.rootData = null;
  }

  load() {
    if (fs.existsSync(this.filename)) {
      this.rootData = JSON.parse(fs.readFileSync(this.filename));
    }
    else {
      this.rootData = {};
    }
  }

  normKey(key) {
    if (typeof (key) === "string") {
      key = key.split(".");
    }
    key = this.base.concat(key);
    return key;
  }

  get(key,useCache = false) {
    if (!useCache || (this.rootData == null)) {
      this.load();
    }

    key = this.normKey(key);

    return _.get(this.rootData,key);
  }


  set(key,val) {
    this.load();
    _.set(this.rootData,key,val);
    fs.writeFileSync(this.filename,JSON.stringify(this.rootData,null,2));
  }
}

module.exports = function(filename,base = []) {
  return new FStore(filename,base);
};
