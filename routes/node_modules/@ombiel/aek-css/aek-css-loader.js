const Path = require("path");
const fs = require("fs");
const _ = require("lodash");

module.exports = function(/*source*/) {

  // const requirePath = require.resolve(this.resourcePath);

  const {resourcePath} = this;
  const pkgPath = Path.resolve("./package.json");
  this.addDependency(pkgPath);
  const pkg = JSON.parse(fs.readFileSync(pkgPath));

  const primaryColor = _.get(
    pkg,
    ["ombiel","settings","cm-lib","styles","primaryColor"],
    _.get(
      pkg,
      ["ombiel","settings","aek-lib","styles","primaryColor"],
      "#444444",
    ),
  );

  const secondaryColor = _.get(
    pkg,
    ["ombiel","settings","cm-lib","styles","secondaryColor"],
    _.get(
      pkg,
      ["ombiel","settings","aek-lib","styles","secondaryColor"],
      "#6f8ea4",
    ),
  );

  const moduleName = Path.basename(resourcePath,".aekcss.js");
  let moduleImport;

  if (moduleName === "base") {
    moduleImport = `
aek-css-module('reset',defaults)
aek-css-module('site',defaults)
`;
  }
  else {
    moduleImport = `aek-css-module('${moduleName}',defaults)`;
  }

  return `
themes = {} // important that you declare themes variable here for global scope
@import "~@ombiel/aek-css/index.styl";


// define baseSizes
fontSize = 14px

// define main colours - for most users this may be sufficient
primeColor = ${primaryColor}
altColor = ${secondaryColor}
textColor = rgba(0, 0, 0, 0.8)
linkColor = saturate(lighten(altColor,30%),100%)
lineHeight = 1.5

// set themes for primary and secondary
aek-css-theme('prime',primeColor)
aek-css-theme('alt',altColor)



// define default vars object to send to all modules
defaults = {
  headerFont:inherit,
  pageFont:inherit,
  emSize:fontSize,
  fontSize:fontSize,
  textColor:textColor,

  headerFontWeight:bold,
  headerLineHeight:1.33em,
  h1:2rem,
  h2:1.714rem,
  h3:1.28rem,
  h4:1.071rem,
  h5:1rem,

  lineHeight:lineHeight,
  paragraphMargin: s('1em 0em 1em'),
  paragraphLineHeight:lineHeight,

  linkColor:linkColor,
  linkUnderline:none,
  linkHoverColor:lighten(linkColor, 5)
}

${moduleImport}

`;


};
