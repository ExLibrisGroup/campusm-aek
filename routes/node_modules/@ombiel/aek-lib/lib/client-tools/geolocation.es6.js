import {defer,extend} from "lodash";
import {EventEmitter} from "@ombiel/cm-lib";
import {getPlatform} from "../utils";

const defaults = {
  maximumAge: 30000
};

let geolocation;
try {
  ({geolocation} = window.navigator.geolocation);
}
catch (e) {} //eslint-disable-line no-empty

export default class Geolocation extends EventEmitter {
  constructor(params = {}) {
    super();
    defer(()=>{
      if (!geolocation) {
        this.trigger("error",Error("NOGEOLOCATION"));
        this.stop();
      }

      // Android doesn't call error callback if user has disabled location services
      // so we default a timeout to avoid long wait
      const presets = getPlatform() === "android" ? {timeout: 5000} : {};

      params = extend(presets,defaults,params);

      const {watch,...opts} = params;
      const method = watch ? "watchPosition" : "getCurrentPosition";

      const success = (position)=>{
        this.trigger("update",position);
        if (!watch) { this.stop(); }
      };

      const error = (err)=>{
        this.trigger("error",err);
        if (!watch) { this.stop(); }
      };

      try {
        this.watchID = geolocation[method](success,error,opts);
      }
      catch (err) {
        this.trigger("error",err);
        this.stop();
      }
    });
  }

  stop() {
    if (this.watchID) {
      geolocation.clearWatch(this.watchID);
    }
    this.off();
  }
}
