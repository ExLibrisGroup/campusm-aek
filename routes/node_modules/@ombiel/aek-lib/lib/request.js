import {extend} from "lodash";
import superagent from "superagent";
import {currentURL} from "./utils";
import screenLink from "./screen-link";

export default extend({},superagent,{

  _postInternal: function(url,opts) {

    var data = { _ombl_is_ajax: "yes" };

    if (opts.action) {
      data._action = opts.action;
    }

    if (opts.sso) {
      var match = url.match(/^\/campusm\/sso/i);
      if (!match) {
        url = `/campusm/sso${url}`;
      }
    }

    url = url.replace(/^\/campusm\/sso\/required/i,"/campusm/sso");

    var token = window.document.body.getAttribute("data-t");

    if (token) { data.ombl_t = token; }

    return superagent.post(url)
    .type('form')
    .send(data);

  },

  action: function(actionName,opts = {}) {
    var cURL = currentURL();
    return this._postInternal(cURL,extend({action: actionName},opts));
  },

  screen: function(screen,opts = {}) {
    return this._postInternal(screenLink(screen),opts);
  }

});
