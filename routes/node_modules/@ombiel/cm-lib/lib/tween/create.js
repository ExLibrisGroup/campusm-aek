import {defer} from "lodash";

import TWEEN from "tween.js";
// load polyfill for older browsers
import "requestanimationframe";

import EventEmitter from "../event-emitter";

let isAnimating = false;
let animRef;





function animate(/*time*/) {
  TWEEN.update();
  animRef = window.requestAnimationFrame(animate);
}

function startAnimation() {
  if (!isAnimating) {
    isAnimating = true;
    animate();
  }
}

function stopAnimation() {
  defer(function() {
    if (animRef && TWEEN.getAll().length === 0) {
      window.cancelAnimationFrame(animRef);
      isAnimating = false;
    }
  });

}



export default function(...args) {
  var tween = new TWEEN.Tween(...args);

  EventEmitter.init(tween);


  tween.onComplete(function(...arg) {
    tween.trigger("complete",...arg);
    stopAnimation();
  });
  tween.onComplete = function(fn) {
    tween.on("complete",fn);
  };
  tween.onStop(function(...arg) {
    tween.trigger("stop",...arg);
    stopAnimation();
  });
  tween.onStop = function(fn) {
    tween.on("stop",fn);
  };
  tween.onUpdate(function(...arg) {
    tween.trigger("update",...arg);
  });
  tween.onUpdate = function(fn) {
    tween.on("update",fn);
  };

  tween.tweenStart = tween.start;

  tween.start = function() {
    startAnimation();
    this.tweenStart();
  };

  return tween;

}
